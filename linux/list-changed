#!/bin/bash -eu

cached=''

while [ $# -ne 0 ]; do
    case $1 in
    --cached)
        cached='--cached'
        shift
    ;;
    --)
        shift
        break
    ;;
    -?*)
        echo "Invalid argument: $1" 1>&2
        exit 1
    ;;
    *)
        break
    ;;
    esac
done

# Walk up parent paths until we git the git directory.
while [ ! -d  '.git/objects' ] && [ "$PWD" != / ]; do
    cd ..
done

if [ ! -d  '.git/objects' ]; then
    echo 'This is not a git repository directory.' 1>&2
    exit 1
fi

function escape-slashes() {
    echo "$1" | sed -r 's/\\\//\//g' | sed -r 's/\//\\\//g'
}

git_root=`pwd`

if [ $# -ne 0 ]; then
    git diff --name-only $cached "$1" | uniq | sed -e "s/^/$(escape-slashes "$git_root")\\//"
else
    git diff --name-only $cached | uniq | sed -e "s/^/$(escape-slashes "$git_root")\\//"
fi
